%%
%% This is file templatedemo.sty',
%%
%% Copyright (C) 2011 Matthias Pospiech (matthias@pospiech.eu)
%%
%% --------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2003/12/01 or later.
%%
%% This work has the LPPL maintenance status 'maintained'.
%%
%% This Current Maintainer of this work is Matthias Pospiech
%%
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{templatedemo}[2011/10/01 demonstrates the possibilities of the template]


\RequirePackage{listings}

\AtBeginDocument{%
%% This code needs to be executed at the beginning
%% of the document because some packages (eg. xcolor)
%% could leed to option clashes otherwise

% === Packages ======================================

% Programming
\RequirePackage{xspace}
\RequirePackage{etoolbox}
% Write contents to files
\RequirePackage{filecontents}
% Package for colors
\RequirePackage{xcolor}
% Packages for frames
\RequirePackage{mdframed}
\RequirePackage{framed}

% === Colors ========================================
\colorlet{demo@stringcolor}{green!40!black!100}
\colorlet{demo@commentcolor}{green!50!black!100}
\colorlet{demo@numbercolor}{white!50!black!100}
\colorlet{demo@codebackcolor}{white!95!black!100}
\colorlet{demo@resultbackcolor}{white}
\definecolor{demo@keywordcolor}{rgb}{0,0.47,0.80}
\definecolor{demo@rulecolor}{rgb}{0,0.4,0.5}
\definecolor{demo@code@rulecolor}{rgb}{0.5,0.5,0.5}

% === Simple Commands ===============================
\newcommand{\bs}{\textbackslash}
\newcommand{\democs}[1]{\democommand{#1}}
\newcommand{\democommand}[1]{\texttt{\bs{}#1}}
\newcommand{\demoenv}[1]{\texttt{#1}}
\newcommand{\demopackage}[1]{\texttt{#1}}
\newcommand{\democodefile}{democode}
\newcommand{\democodeprefix}{Code: }
\newcommand{\demoresultprefix}{\noindent Result:}

%% Print Error
\newcommand{\DemoError}[1]{
  \ifcsdef{textcolor}
    {\textcolor{red}{Error:~}}
    {Error:~}
  #1 \par\noindent
}


% === Define Keys ===================================

\RequirePackage{kvoptions-patch}
\RequirePackage{kvoptions}  % options
\RequirePackage{pdftexcmds} % string comparison

\SetupKeyvalOptions{family=demo,prefix=demo@}

% parallel, stacked, lines, page
\DeclareStringOption[stacked]{style}

\ProcessKeyvalOptions{demo}

\newcommand{\PrintDemoUsingKeys}{%
  \ifnum\pdf@strcmp{\demo@style}{parallel}=0%
    \PrintCodeAndResultsParallel%
  \else\ifnum\pdf@strcmp{\demo@style}{stacked}=0%
    \PrintCodeAndResultsStacked%
  \else\ifnum\pdf@strcmp{\demo@style}{lines}=0%
    \PrintCodeAndResultsStackedLines%
  \else\ifnum\pdf@strcmp{\demo@style}{page}=0%
    \PrintCodeAndResultsPage%
  \else\ifnum\pdf@strcmp{\demo@style}{none}=0%
    \PrintCodeAndResultsNone%
  \else%
     \PackageError{templatedemo}{%
       \MessageBreak%
       value >\tplbugs@style< unkown \MessageBreak%
     }{}%
  \fi\fi\fi\fi\fi%
}%

% Print code and result using the key-value syntax
\newcommand{\PrintDemo}[1]{%
\begingroup
  \setkeys{demo}{#1}%
  \PrintDemoUsingKeys
\endgroup
}    


% === Listings style ================================
\lstdefinestyle{demostyle}{
  columns=flexible,
  keepspaces=true,    
  numberstyle=\tiny\color{demo@numbercolor},%
  %
  basicstyle=\small\ttfamily,%
  numbers=none,%
  stepnumber=1,%
  numbersep=5pt,%
  tabsize=2,%
  extendedchars=true,%
  breaklines=true,%
  stringstyle=\color{demo@stringcolor}, %
  keywordstyle=\color{demo@keywordcolor}, %
  commentstyle=\color{demo@commentcolor}, %
  showspaces=false,%
  showtabs=false,%
  showstringspaces=false,%
  frame=single,%
  backgroundcolor=\color{demo@codebackcolor},%
  rulecolor=\color{demo@code@rulecolor},%
  language = [LaTeX]TeX,%
%  morekeywords
  moretexcs={maketitle,tableofcontents,subsection,text,includegraphics,
  chapter,tableofcontents,section,subsection,subsubsection,paragraph,si,SI,
  textmu,newcolumntype,rowcolor,rowcolors,bottomrule,toprule,midrule,
  mainmatter,frontmatter,geometry,KOMAoptions,enquote,blockquote,ding,mathds,
  ifcsdef,mathcal,underset,operatorname,sfrac,Bra,Ket,Braket,setlength,subcaption,
  sisetup,rowfont,taburowcolors,theadstart,tbody,tsubheadstart,tsubhead,tend,
  unit,unitfrac,micro,gls,printglossary,glsadd,newglossaryentry,lettrine,mdfsetup,democodefile,demopackage,democs,democommand,demoenv,DemoError},
}



\lstloadlanguages{[LaTeX]TeX}

% create new environment for listings
\lstnewenvironment{latexcode}{%
\lstset{style=demostyle, inputencoding=latin1, escapeinside=!!}%
\democodeprefix
}{}

% === Mdframed style ================================
\mdfdefinestyle{DemoStyleFrames}{
  linecolor=demo@rulecolor,%
  linewidth=0.8pt,
  skipabove=0pt,
  skipbelow=0.5\baselineskip,
  leftmargin =-3.5pt,
  rightmargin=-3.5pt,
  innerleftmargin=3pt,
  innerrightmargin=3pt,
}% 


% === Commands for Results =========================

\newcommand{\preResultSkip}{\vspace*{-0.5\baselineskip}}

%% Box for results
\newenvironment{latexresult}{%
\demoresultprefix
\nopagebreak[4]
\preResultSkip
\mdframed[%
  style=DemoStyleFrames,
  backgroundcolor=demo@resultbackcolor,%
  usetwoside=false,
]%
}{
\endmdframed
\noindent
}

%% Single Line for results
\newcommand{\resultline}{%
\nopagebreak[4]
% Insert single line
\mdframed[%
  style=DemoStyleFrames,
  skipabove=3pt,
  skipbelow=3pt,
  topline=true,bottomline=false,leftline=false,rightline=false,
  backgroundcolor=white,%
]\mbox{}\endmdframed
\nopagebreak[4]
}

% Print Code with prefix
\newcommand{\printlatexcode}{%
\democodeprefix
\lstinputlisting[style=demostyle,nolol=true]{\democodefile}%
}%

% Print Result with standard box
\newcommand{\printlatexresult}{%
\begin{latexresult}%
\IfFileExists{\democodefile}{\input{\democodefile}}{}%
\end{latexresult}%
}%

% Print result with lines 
\newcommand{\printlatexresultlines}{%
\demoresultprefix
\nopagebreak[4] \resultline \nopagebreak[4]
\IfFileExists{\democodefile}{\input{\democodefile}}{}%
\nopagebreak[4] \resultline \nopagebreak[4]
}%


\newcommand{\PrintCodeAndResultsParallel}{%
\nopagebreak[4]
\vspace*{0.5em}\par\noindent
\begin{minipage}[t]{0.48\linewidth}
\printlatexcode
\end{minipage} \hfill
\begin{minipage}[t]{0.48\linewidth}
\printlatexresult
\end{minipage}
\par\noindent
}

\newcommand{\PrintCodeAndResultsStacked}{%
\nopagebreak[4]
\vspace*{0.5em}\par\noindent
\printlatexcode%
\printlatexresult%
\par\noindent
}%


\newcommand{\PrintCodeAndResultsStackedLines}{%
\nopagebreak[4]
\vspace*{0.5em}\par\noindent
\printlatexcode%
\printlatexresultlines%
\vspace*{0.5em}\par\noindent
}%

\newcommand{\PrintCodeAndResultsNone}{%
\nopagebreak[4]
\vspace*{0.5em}\par\noindent
\printlatexcode%
%
\demoresultprefix
\nopagebreak[4]
\par\noindent
\IfFileExists{\democodefile}{\input{\democodefile}}{}%
%
\vspace*{0.5em}\par\noindent
}%




\newcommand{\PrintCodeAndResultsPage}{%
\nopagebreak[4]
\vspace*{0.5em}\par\noindent
\printlatexcode%
\demoresultprefix: Shown on the following page.
\newpage
\IfFileExists{\democodefile}{\input{\democodefile}}{}%
\newpage
}%

} % end of \AtBeginDocument